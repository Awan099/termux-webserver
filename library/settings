#!/data/data/com.termux/files/usr/bin/bash
#
# Installation Webserver
#
# @author Ayus Irfang Filaras <ayus.sahabat@gmail.com
# @lisence GPL
#
lamppScript()
{
    progress "Menyalin data konfigurasi" 15
    cp -rf etc /data/data/com.termux/files/usr/var/
    cp -rf tmp /data/data/com.termux/files/usr/var/
    echo -e "\e[32;m[√] Sukses menyalin data.\e[0m"

    progress "Menginstall lampp script" 15
    cp lampp-script /data/data/com.termux/files/usr/bin/lampp
    echo -e "\e[32;m[√] Berhasil menginstall lampp script.\e[0m\n"
    bash lampp --help

    exit 1
}

lamppScriptQuestion()
{
    echo -ne "\n\e[32;m>\e[0m Apakah Anda ingin menginstall lampp-script? ";
    read -p "[Y/N] (Tekan enter untuk batal) " jawaban

    case ${jawaban} in
        "Y"|"y")
            lamppScript
            ;;

        "N"|"n"|*)
            echo -ne "\n"
            lampp --help
            exit 1
            ;;
    esac
}

# Mengatur symbolic direktori
__ln()
{
    while true;
    do
        formSourceLN
    done
}

formSourceLN()
{
    echo -e "\n\e[32;m>\e[0m Masukan direktori source contoh: ~/storage/shared/www"
    read -p "Source folder: " source

    progress "[Cek direktori]" 10

    formCheckSourceLN ${source}
}

formCheckSourceLN()
{
    if [ ! -z ${source} ]; then
        # Cek apakah direktori source ada
        if ! [ -d ${source} ]; then
            formSymbolic ${source}
        else
            echo -e "\e[31;mDirektori ${source} tidak dapat ditemukan.\e[0m"
        fi
    else
        echo -e "\e[31;mMaaf, Anda tidak memasukkan direktori source.\e[0m"
    fi
}

formSymbolic()
{
    echo -e "\e[32;m>\e[0m Masukan direktori symbolic link contoh: /data/data/com.termux/files/usr/var"
    read -p "Symbolic folder: " target

    progress "[Cek symbolic link]" 10

    formCheckSymbolic ${source} ${target}
}

formCheckSymbolic()
{
    # Cek symbolic jika sudah ada
    if [ -h ${target}/www ]; then
        echo -e "\e[31;mSymbolic link sudah ada.\e[0m"
        lamppScriptQuestion
    else
        if [ -f ~/createlink ]; then
            rm ~/createlink
            wget -P ~/ https://raw.githubusercontent.com/apolbox/termux-webserver/dev/createlink
            chmod +x ~/createlink
            cp ~/createlink /data/data/com.termux/files/usr/bin/
            createlink $source $target
        else
            wget -P ~/ https://raw.githubusercontent.com/apolbox/termux-webserver/dev/createlink
            chmod +x ~/createlink
            cp ~/createlink /data/data/com.termux/files/usr/bin/
            createlink $source $target
        fi

        #echo -e "\e[32;mBerhasil membuat symbolic link.\e[0m"
        lamppScriptQuestion
    fi
}

progress()
{
    echo -ne "\n\e[33;m${1}\e[0m ";

    timeout=0;

    echo -ne "\e[34;m";

    while [ $timeout -lt ${2} ]
    do
        timeout=`expr $timeout + 1`
        echo -ne "${timeout}" | sed 's/[0-9]/./g';
        sleep 1
    done

    echo -ne "\e[0m\n\n";
}

case ${1} in
    "--ln")
        __ln
        ;;
    "--ls")
        lamppScript
        ;;
    "--lsq")
        lamppScriptQuestion
        ;;
esac
