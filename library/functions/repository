#!/usr/bin/bash
#
# Update && Upgrade repository local
#
repository()
{
    case ${1} in
        "--update")
            progress "[*] Cek pembaruan" 5
            scanOldFile
            ;;
    esac
}

scanOldFile()
{
    # Membuat variabel global version
    global_version="$(repositoryVersion)"

    # Membuat variabel local version
    local_version="$(cat $WEB_SERVER_DIR/version.txt)"

    # Membuat versi terakhir
    latest_version="${local_version}"

    # Mengolah scan file lama
    for i in $WEB_SERVER_DIR/*
    do
        echo -ne "[+] "
        if [ -d $i ]; then
            echo -ne "\e[34;m"
            echo -ne "$i" | cut -f 5 -d '/' | tr -d '\n'
            echo -ne "\e[0m"

            if [[ ${local_version} != ${global_version} ]]; then
                echo -ne "\e[31;m (versi ${local_version})\e[0m"
                echo -ne "\e[32;m (upgrade to versi ${global_version})\e[0m\n"
            else
                echo -ne "\e[32;m (versi terakhir ${latest_version})\n\e[0m"
            fi
            sleep 1
            continue
        else
            echo -ne "$i" | cut -f 5 -d '/' | tr -d '\n'

            if [[ ${local_version} != ${global_version} ]]; then
                echo -ne "\e[31;m (versi ${local_version})\e[0m"
                echo -ne "\e[32;m (upgrade to versi ${global_version})\e[0m\n"
            else
                echo -ne "\e[32;m (versi terakhir ${latest_version})\n\e[0m"
            fi
            sleep 1
        fi
    done

    echo -ne "\n[?] Apakah anda ingin mengunduh pembaruan? [y/n] "; read j
    repositoryDownload $j
}

repositoryDownload()
{
    url="https://github.com/apolbox/termux-webserver/archive/dev.zip"
    fs=$(getSizeOfUrl ${url})

    case ${1} in
        "Y"|"y")
            progress "[*] Mengunduh pembaruan" 5
            echo -ne "\e[31;m[!]\e[0m Total pembaruan: $(echo ${fs} | readSize)\n\n"
            progress-bar ${fs}
            curl -s ${url} > $WEB_SERVER_DIR/tmp/dev.zip

            echo -ne "\n\n[?] Apakah anda ingin memasang pembaruan? [y/n] "; read a
            
            repositoryUpgrade $a
            ;;
        "N"|"n"|*)
            exit 1
            ;;
    esac
}

repositoryVersion()
{
    cat $WEB_SERVER_DIR/tmp/version.txt
}

repositoryUpgrade()
{
    echo ${1}
}
