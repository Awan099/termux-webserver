#!/usr/bin/bash
#
# Update && Upgrade repository local
#
repository()
{
    local global_version
    local latest_version

    $(curl -s https://raw.githubusercontent.com/apolbox/termux-webserver/dev/version.txt --output $WEB_SERVER_DIR/tmp/global_version.txt);
    $(curl -s https://raw.githubusercontent.com/apolbox/termux-webserver/master/version.txt --output $WEB_SERVER_DIR/tmp/master_version.txt);

    global_version=$(cat $WEB_SERVER_DIR/tmp/global_version.txt);
    latest_version=$(cat $WEB_SERVER_DIR/tmp/master_version.txt);
    
    repository_upgrade()
    {
        case ${1} in
            "Y"|"y")
                progress "[*] Memasang pembaruan" 5
                unzip -o $WEB_SERVER_DIR/repository/tmp/${global_version}.zip -d $WEB_SERVER_DIR
                
                if [ -d $WEB_SERVER_DIR/termux-webserver-* ]; then
                    cp -rf termux-webserver-*/* $WEB_SERVER_DIR
                fi
                
                if [ -d $WEB_SERVER_DIR/apolbox-* ]; then
                    cp -rf apolbox-*/* $WEB_SERVER_DIR
                fi
                clear
                
                progress "[*] Membersihkan sampah" 5
                rm -rf $WEB_SERVER_DIR/repository
                rm -f $WEB_SERVER_DIR/tmp/repository.zip
                if [ -d $WEB_SERVER_DIR/repository ] && [ -f $WEB_SERVER_DIR/tmp/repository.zip ]; then
                    rm -rf $WEB_SERVER_DIR/repository
                    rm -f $WEB_SERVER_DIR/tmp/repository.zip
                else
                    sleep 1
                    echo -ne "\e[32;m[√] Sukses membersihkan sampah.\e[0m\n"
                fi
                
                progress "[*] Mengoptimalkan versi lampp" 5
                mkdir -p $PREFIX/etc/lampp
                cp -rf $WEB_SERVER_DIR/library $PREFIX/etc/lampp/
                cp -f $WEB_SERVER_DIR/version.txt $PREFIX/etc/lampp/
                cp -f $WEB_SERVER_DIR/lampp-script $PREFIX/bin/lampp
                chmod +x $PREFIX/bin/lampp
                echo -ne "\e[32;m[√] Pembaruan berhasil.\e[0m\n"
                ;;
            "N"|"n"|*)
                exit 1
                ;;
        esac
    }
    
    repository_download()
    {
        ref=$(cat $WEB_SERVER_DIR/tmp/global_version.txt)
        url=${URL_DOWNLOAD}${ref}.zip
        
        case ${1} in
            "Y"|"y")
                progress "[*] Mengunduh pembaruan" 5
                if ! [ -f "$WEB_SERVER_DIR/repository/tmp/${ref}.zip" ]; then
                    $(curl -# -L ${url} --output $WEB_SERVER_DIR/repository/tmp/${ref}.zip)
                    #php $WEB_SERVER_DIR/repository/download/index.php ${URL_DOWNLOAD}${global_version}
                    #if [[-f $WEB_SERVER_DIR/repository/tmp/${ref}.zip]]; then
                    #    echo -ne "\e[32;mDownload berhasil\e[0m\n";
                    #    echo -ne "\n[?] Apakah anda ingin memasang pembaruan? [y/n] "; read archive
                    repository_upgrade $archive
                    #else
                    #    echo -ne "\e[31;mDownload gagal!\e[0m";
                    #    exit;
                    #fi
                else
                    echo -ne "\e[32;m[√] File pembaruan sudah ada.\e[0m\n"
                    echo -ne "\n[?] Apakah anda ingin memasang pembaruan? [y/n] "; read archive
                    repository_upgrade $archive
                fi
                ;;
            "N"|"n"|*)
                exit 1
                ;;
        esac
    }
    
    repository_update()
    {
        for i in ./*
        do
            if [ -d $i ]; then
                echo $i > $WEB_SERVER_DIR/tmp/listdir.txt
                listdir=$(cat $WEB_SERVER_DIR/tmp/listdir.txt | cut -f 2 -d '/')
                
                printf "[+] \e[34;m%-16s\e[0m [\e[31;mversi %s\e[0m] upgrade to [\e[32;mversi %s\e[0m]\n" "${listdir}" "${latest_version}" "${global_version}"
                sleep 0.1
            else
                echo $i > $WEB_SERVER_DIR/tmp/listfiles.txt
                listfiles=$(cat $WEB_SERVER_DIR/tmp/listfiles.txt | cut -f 2 -d '/')
                
                printf "[+] %-16s [\e[31;mversi %s\e[0m] upgrade to [\e[32;mversi %s\e[0m]\n" "${listfiles}" "${latest_version}" "${global_version}"
                sleep 0.1
            fi
        done
        
        printf "\n[?] %s" "Apakah anda ingin mengunduh pembaruan? [y/n] "; read answer
        repository_download $answer
    }

    case ${1} in
        "--update")
            welcome
            progress "[*] Mengecek pembaruan" 5
            repository_update;
            ;;
    esac
}
