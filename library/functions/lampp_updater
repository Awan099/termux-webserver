#!/usr/bin/bash
# Lampp Web Server
#
# Daftar list yang dapat digunakan:
# [+] start
# [+] stop
# [+] update
# [+] version
#
# @author Ayus Irfang Filaras
# @license Apache-2.0
#
LAMPP_PARAMETER=${LAMPP_PARAMETER:=${1}}

lampp()
{
    local latest_version
    local global_version
    local fileconfig
    local hostname
    local port
    
    fileconfig=/data/data/com.termux/files/usr/var/etc/config/lighttpd.conf
    hostname=$(cat $fileconfig | grep 'server.bind' | cut -f 2 -d '"')
    port=$(cat $fileconfig | grep 'server.port' | cut -f 3 -d ' ')
   
    # Mengecek versi dari lampp yang terinstall.
    # /data/data/com.termux/files/usr/etc/lampp/version.txt atau $PREFIX/etc/lampp/version.txt
    latest_version() { latest_version=$(cat $PREFIX/etc/lampp/version.txt); }
    global_version() {
        $(curl -s https://raw.githubusercontent.com/apolbox/termux-webserver/dev/version.txt --output $PREFIX/etc/lampp/global_version.txt);
        global_version=$(cat $PREFIX/etc/lampp/global_version.txt);
    }
    
    # Menjalankan perintah upgrade
    lampp_upgrade()
    {
        cp -rf $WEB_SERVER_DIR/library $PREFIX/etc/lampp/
        cp -f $PREFIX/etc/lampp/global_version.txt $PREFIX/etc/lampp/version.txt
        cp -f $WEB_SERVER_DIR/lampp-script $PREFIX/bin/lampp
        chmod +x $PREFIX/bin/lampp
        sleep 1
        echo -ne "\e[32;mBerhasil memperbarui versi lampp\e[0m"
    }
    
    # Untuk update versi dari lampp server
    lampp_update()
    {
        if [[ $latest_version != $global_version ]]; then
            if ! [ -d $PREFIX/etc/lampp ]; then
                mkdir -p $PREFIX/etc/lampp
                lampp_upgrade;
            else
                lampp_upgrade;
            fi
        else
            echo -ne "\e[32;m[√] Versi lampp sudah yang terbaru.\e[0m\n"
            sleep 1
        fi
    }
    
    # Memfilter perintah-perintah dari lampp server
    lampp_command()
    {
        case ${LAMPP_PARAMETER} in
            "start")
                lighttpd -f $fileConfig
                echo -e "\e[32;mWebserver berjalan di http://${hostnam}e:${port}/\n\e[0m"
                ;;

            "stop")
                echo -e "\e[32;mMenghentikan webserver yang berjalan di http://${hostname}:${port}/\e[0m\n";
                killall lighttpd
                ;;
    
            "--help"|"-h")
                echo -ne "usage: `basename ${0}` [start|stop] [-v|--version version] [-h|--help help] [--update]\n"
                ;;
                
            "--update")
                lampp_update
                ;;

    #"--edit-config")
    #    echo "${2}" > tmp/edit-config.txt | sed -i 's=/=\\/=g' tmp/edit-config.txt;
    #    x=$(cat tmp/edit-config.txt | awk '{print $1}')
    #    y=$(cat ${fileConfig} | tr '\n' '\r' | awk '{print $1}')
    #    echo "server.document-root=" | sed -i "s|${y}|\"${x}\"|g" ${fileConfig}
    #
    #   echo -e "\e[32;m[√] File konfigurasi berhasil diperbarui.\e[0m"
    #   ;;

            "-v"|"--version")
                echo -e "\e[32;mLampp version \e[31;m${latest_version}\e[0m\e[0m"
                ;;

            *)
                echo "usage: `basename ${0}` [start|stop] [-v|--version version] [-h|--help help] [--update]\n" 
                exit 1 # Command to come out of the program with status 1;;
        esac
    }
    
    latest_version; global_version; lampp_command;
}
